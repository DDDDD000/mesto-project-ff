(()=>{"use strict";function e(e){"Escape"===e.key&&r(document.querySelector(".popup_is-opened"))}function t(e){e.target===e.currentTarget&&r(e.currentTarget)}function n(n){n.classList.add("popup_is-opened"),document.addEventListener("keydown",e),n.addEventListener("click",t)}function r(n){n.classList.remove("popup_is-opened"),document.removeEventListener("keydown",e),n.removeEventListener("click",t)}var o={baseUrl:"https://mesto.nomoreparties.co/v1/wff-cohort-40",headers:{authorization:"3288a148-b765-4961-8ec1-f86ec90a7c0a","Content-Type":"application/json"}},c=document.querySelector("#card-template").content;function a(e,t){var n=t.handleCardLike,r=t.handleImageOpen,a=c.querySelector(".places__item").cloneNode(!0),i=a.querySelector(".card__delete-button"),u=a.querySelector(".card__image"),s=a.querySelector(".card__title"),l=a.querySelector(".card__image"),d=a.querySelector(".card__like-button"),p=a.querySelector(".card__like-count");return u.src=e.link,s.textContent=e.name,l.alt=e.name,p.textContent=e.likes.length,"ba745ef116e75b64f2466c34"!=e.owner._id&&i.remove(),i.addEventListener("click",(function(){var t;(t=e._id,fetch("".concat(o.baseUrl,"/cards/").concat(t),{method:"DELETE",headers:o.headers}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).catch((function(e){throw console.error("Ошибка при удалении карточки:",e),e}))).then((function(){return a.remove()})).catch((function(e){return console.error("Ошибка удаления:",e)}))})),u.addEventListener("click",(function(){return r({link:e.link,name:e.name})})),e.likes.some((function(e){return"ba745ef116e75b64f2466c34"===e._id}))&&d.classList.add("card__like-button_is-active"),d.addEventListener("click",(function(t){n(t,e._id,p)})),a}function i(e,t,n){var r=e.target,c=r.classList.contains("card__like-button_is-active")?function(e){return fetch("".concat(o.baseUrl,"/cards/likes/").concat(e),{method:"DELETE",headers:o.headers}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).catch((function(e){throw console.error("Ошибка при попытке убрать лайк:",e),e}))}(t):function(e){return fetch("".concat(o.baseUrl,"/cards/likes/").concat(e),{method:"PUT",headers:o.headers}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).catch((function(e){throw console.error("Ошибка при попытке поставить лайк:",e),e}))}(t);c.then((function(e){r.classList.toggle("card__like-button_is-active"),n.textContent=e.likes.length})).catch((function(e){console.error("Ошибка при лайке:",e)}))}var u=function(e,t){!function(e){return e.some((function(e){return!e.validity.valid}))}(e)?(t.disabled=!1,t.classList.remove("popup__button-disabled")):(t.disabled=!0,t.classList.add("popup__button-disabled"))},s=function(e,t){var n=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);n.forEach((function(n){var r=e.querySelector(".".concat(n.id,"-error"));n.classList.remove(t.inputErrorClass),n.classList.remove("popup__input-valid-error"),r&&(r.classList.remove(t.errorClass),n.classList.remove("popup__input-valid-error"),r.textContent=""),n.setCustomValidity("")})),r.disabled=!0,r.classList.remove(t.inactiveButtonClass)},l={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button-disabled",inputErrorClass:"form__input_type_error",errorClass:"form__input-error_active"},d=document.querySelector(".profile__edit-button"),p=document.querySelector(".profile__add-button"),f=document.querySelector(".profile__image"),_=document.querySelectorAll(".popup__close"),m=document.querySelector(".popup_type_edit"),h=document.querySelector(".popup_type_new-card"),v=document.querySelector(".popup_type_image"),y=document.querySelector(".popup_type_change-pfp"),b=document.forms["edit-profile"],k=document.forms["new-place"],S=document.forms["pfp-change"],L=document.querySelector(".places__list"),C=v.querySelector(".popup__image"),q=v.querySelector(".popup__caption");_.forEach((function(e){var t=e.closest(".popup");e.addEventListener("click",(function(){var e=t.querySelector(".popup__form");e&&(e.reset(),s(e,l)),r(t)})),t.classList.add("popup_is-animated")}));var g=document.querySelector(".profile__title"),E=document.querySelector(".profile__description"),x=document.querySelector(".profile__image");function j(e){var t=e.link,r=e.name;C.src=t,C.alt=r,q.textContent=r,n(v)}d.addEventListener("click",(function(){b.elements.name.value=g.textContent,b.elements.description.value=E.textContent,s(b,l),n(m)})),b.addEventListener("submit",(function(e){e.preventDefault();var t,n,c=b.querySelector(".popup__button"),a=c.textContent;c.textContent="Сохранение...",c.disabled=!0,(t=b.elements.name.value,n=b.elements.description.value,fetch("".concat(o.baseUrl,"/users/me"),{method:"PATCH",headers:o.headers,body:JSON.stringify({name:t,about:n})}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).catch((function(e){throw console.error("Ошибка при обновлении профиля:",e),e}))).then((function(e){g.textContent=e.name,E.textContent=e.about,r(m)})).catch((function(e){console.error("Ошибка при обновлении профиля:",e),alert("Не удалось сохранить изменения. Пожалуйста, попробуйте ещё раз.")})).finally((function(){c.textContent=a,c.disabled=!1}))})),p.addEventListener("click",(function(){k.reset(),s(k,l),n(h)})),k.addEventListener("submit",(function(e){e.preventDefault();var t=k.querySelector(".popup__button"),n=t.textContent;t.textContent="Сохранение...",t.disabled=!0;var c,u,s={name:k.elements["place-name"].value,link:k.elements.link.value};(c=s.name,u=s.link,fetch("".concat(o.baseUrl,"/cards"),{method:"POST",headers:o.headers,body:JSON.stringify({name:c,link:u})}).then((function(e){if(!e.ok)throw new Error("Ошибка: ".concat(e.status));return e.json()})).catch((function(e){throw console.error("Ошибка при добавлении карточки:",e),e}))).then((function(e){var t=a(e,{handleCardLike:i,handleImageOpen:j});L.prepend(t),r(h)})).catch((function(e){console.error("Ошибка при добавлении карточки:",e),alert("Не удалось сохранить изменения. Пожалуйста, попробуйте ещё раз.")})).finally((function(){t.textContent=n,t.disabled=!1}))})),f.addEventListener("click",(function(){S.reset(),s(S,l),n(y)})),S.addEventListener("submit",(function(e){e.preventDefault();var t,n=S.querySelector(".popup__button"),c=n.textContent;n.textContent="Сохранение...",n.disabled=!0,(t=S.elements.link.value,fetch("".concat(o.baseUrl,"/users/me/avatar"),{method:"PATCH",headers:o.headers,body:JSON.stringify({avatar:t})}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).catch((function(e){throw console.error("Ошибка при обновления аватара:",e),e}))).then((function(e){x.style.backgroundImage="url('".concat(e.avatar,"')"),r(y)})).catch((function(e){console.error("Ошибка при обновлении аватара:",e),alert("Не удалось сохранить изменения. Пожалуйста, попробуйте ещё раз.")})).finally((function(){n.textContent=c,n.disabled=!1}))})),Array.from(document.querySelectorAll(".popup__form")).forEach((function(e){!function(e){var t=Array.from(e.querySelectorAll(".popup__input")),n=e.querySelector(".popup__button");u(t,n),t.forEach((function(r){r.addEventListener("input",(function(){!function(e,t){t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage):t.setCustomValidity(""),t.validity.valid?function(e,t){var n=e.querySelector(".".concat(t.id,"-error"));t.classList.remove("form__input_type_error"),n.classList.remove("form__input-error_active"),n.textContent=""}(e,t):function(e,t,n){var r=e.querySelector(".".concat(t.id,"-error"));t.classList.add("form__input_type_error"),r.textContent=n,r.classList.add("form__input-error_active")}(e,t,t.validationMessage);var n=e.checkValidity();t.classList.toggle("popup__input-valid-error",!n)}(e,r),u(t,n)}))}))}(e)})),fetch("".concat(o.baseUrl,"/users/me"),{headers:o.headers}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).catch((function(e){throw console.error("Ошибка при загрузке профиля:",e),e})).then((function(e){return e._id,g.textContent=e.name,E.textContent=e.about,x.style.backgroundImage="url('".concat(e.avatar,"')"),fetch("".concat(o.baseUrl,"/cards"),{headers:o.headers}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).catch((function(e){throw console.error("Ошибка при загрузке карточек:",e),e}))})).then((function(e){!function(e){var t=document.querySelector(".places__list");t.innerHTML="",e.forEach((function(e){var n=a(e,{handleCardLike:i,handleImageOpen:j});t.append(n)}))}(e)})).catch((function(e){console.error("Ошибка загрузки данных:",e)}))})();